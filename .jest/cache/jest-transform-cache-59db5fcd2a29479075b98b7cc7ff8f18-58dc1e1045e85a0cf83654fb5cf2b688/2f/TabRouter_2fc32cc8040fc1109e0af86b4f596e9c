57337c877b895aaf33dbf6a628bd9d38
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault2(require("@babel/runtime/helpers/defineProperty"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = TabRouter;
exports.TabActions = void 0;

var _nonSecure = require("nanoid/non-secure");

var _BaseRouter = _interopRequireDefault(require("./BaseRouter"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

var TYPE_ROUTE = 'route';
var TabActions = {
  jumpTo: function jumpTo(name, params) {
    return {
      type: 'JUMP_TO',
      payload: {
        name: name,
        params: params
      }
    };
  }
};
exports.TabActions = TabActions;

var getRouteHistory = function getRouteHistory(routes, index, backBehavior, initialRouteName) {
  var history = [{
    type: TYPE_ROUTE,
    key: routes[index].key
  }];
  var initialRouteIndex;

  switch (backBehavior) {
    case 'order':
      for (var i = index; i > 0; i--) {
        history.unshift({
          type: TYPE_ROUTE,
          key: routes[i - 1].key
        });
      }

      break;

    case 'firstRoute':
      if (index !== 0) {
        history.unshift({
          type: TYPE_ROUTE,
          key: routes[0].key
        });
      }

      break;

    case 'initialRoute':
      initialRouteIndex = routes.findIndex(function (route) {
        return route.name === initialRouteName;
      });
      initialRouteIndex = initialRouteIndex === -1 ? 0 : initialRouteIndex;

      if (index !== initialRouteIndex) {
        history.unshift({
          type: TYPE_ROUTE,
          key: routes[initialRouteIndex].key
        });
      }

      break;

    case 'history':
      break;
  }

  return history;
};

var changeIndex = function changeIndex(state, index, backBehavior, initialRouteName) {
  var history;

  if (backBehavior === 'history') {
    var currentKey = state.routes[index].key;
    history = state.history.filter(function (it) {
      return it.type === 'route' ? it.key !== currentKey : false;
    }).concat({
      type: TYPE_ROUTE,
      key: currentKey
    });
  } else {
    history = getRouteHistory(state.routes, index, backBehavior, initialRouteName);
  }

  return _objectSpread(_objectSpread({}, state), {}, {
    index: index,
    history: history
  });
};

function TabRouter(_ref) {
  var initialRouteName = _ref.initialRouteName,
      _ref$backBehavior = _ref.backBehavior,
      backBehavior = _ref$backBehavior === void 0 ? 'firstRoute' : _ref$backBehavior;

  var router = _objectSpread(_objectSpread({}, _BaseRouter.default), {}, {
    type: 'tab',
    getInitialState: function getInitialState(_ref2) {
      var routeNames = _ref2.routeNames,
          routeParamList = _ref2.routeParamList;
      var index = initialRouteName !== undefined && routeNames.includes(initialRouteName) ? routeNames.indexOf(initialRouteName) : 0;
      var routes = routeNames.map(function (name) {
        return {
          name: name,
          key: name + "-" + (0, _nonSecure.nanoid)(),
          params: routeParamList[name]
        };
      });
      var history = getRouteHistory(routes, index, backBehavior, initialRouteName);
      return {
        stale: false,
        type: 'tab',
        key: "tab-" + (0, _nonSecure.nanoid)(),
        index: index,
        routeNames: routeNames,
        history: history,
        routes: routes
      };
    },
    getRehydratedState: function getRehydratedState(partialState, _ref3) {
      var routeNames = _ref3.routeNames,
          routeParamList = _ref3.routeParamList;

      var _state$routes, _state$index, _state$history$filter, _state$history;

      var state = partialState;

      if (state.stale === false) {
        return state;
      }

      var routes = routeNames.map(function (name) {
        var route = state.routes.find(function (r) {
          return r.name === name;
        });
        return _objectSpread(_objectSpread({}, route), {}, {
          name: name,
          key: route && route.name === name && route.key ? route.key : name + "-" + (0, _nonSecure.nanoid)(),
          params: routeParamList[name] !== undefined ? _objectSpread(_objectSpread({}, routeParamList[name]), route ? route.params : undefined) : route ? route.params : undefined
        });
      });
      var index = Math.min(Math.max(routeNames.indexOf((_state$routes = state.routes[(_state$index = state === null || state === void 0 ? void 0 : state.index) !== null && _state$index !== void 0 ? _state$index : 0]) === null || _state$routes === void 0 ? void 0 : _state$routes.name), 0), routes.length - 1);
      var history = (_state$history$filter = (_state$history = state.history) === null || _state$history === void 0 ? void 0 : _state$history.filter(function (it) {
        return routes.find(function (r) {
          return r.key === it.key;
        });
      })) !== null && _state$history$filter !== void 0 ? _state$history$filter : [];
      return changeIndex({
        stale: false,
        type: 'tab',
        key: "tab-" + (0, _nonSecure.nanoid)(),
        index: index,
        routeNames: routeNames,
        history: history,
        routes: routes
      }, index, backBehavior, initialRouteName);
    },
    getStateForRouteNamesChange: function getStateForRouteNamesChange(state, _ref4) {
      var routeNames = _ref4.routeNames,
          routeParamList = _ref4.routeParamList,
          routeKeyChanges = _ref4.routeKeyChanges;
      var routes = routeNames.map(function (name) {
        return state.routes.find(function (r) {
          return r.name === name && !routeKeyChanges.includes(r.name);
        }) || {
          name: name,
          key: name + "-" + (0, _nonSecure.nanoid)(),
          params: routeParamList[name]
        };
      });
      var index = Math.max(0, routeNames.indexOf(state.routes[state.index].name));
      var history = state.history.filter(function (it) {
        return it.type !== 'route' || routes.find(function (r) {
          return r.key === it.key;
        });
      });

      if (!history.length) {
        history = getRouteHistory(routes, index, backBehavior, initialRouteName);
      }

      return _objectSpread(_objectSpread({}, state), {}, {
        history: history,
        routeNames: routeNames,
        routes: routes,
        index: index
      });
    },
    getStateForRouteFocus: function getStateForRouteFocus(state, key) {
      var index = state.routes.findIndex(function (r) {
        return r.key === key;
      });

      if (index === -1 || index === state.index) {
        return state;
      }

      return changeIndex(state, index, backBehavior, initialRouteName);
    },
    getStateForAction: function getStateForAction(state, action, _ref5) {
      var routeParamList = _ref5.routeParamList;

      switch (action.type) {
        case 'JUMP_TO':
        case 'NAVIGATE':
          {
            var index = -1;

            if (action.type === 'NAVIGATE' && action.payload.key) {
              index = state.routes.findIndex(function (route) {
                return route.key === action.payload.key;
              });
            } else {
              index = state.routes.findIndex(function (route) {
                return route.name === action.payload.name;
              });
            }

            if (index === -1) {
              return null;
            }

            return changeIndex(_objectSpread(_objectSpread({}, state), {}, {
              routes: state.routes.map(function (route, i) {
                if (i !== index) {
                  return route;
                }

                var params;

                if (action.type === 'NAVIGATE' && action.payload.merge) {
                  params = action.payload.params !== undefined || routeParamList[route.name] !== undefined ? _objectSpread(_objectSpread(_objectSpread({}, routeParamList[route.name]), route.params), action.payload.params) : route.params;
                } else {
                  params = routeParamList[route.name] !== undefined ? _objectSpread(_objectSpread({}, routeParamList[route.name]), action.payload.params) : action.payload.params;
                }

                var path = action.type === 'NAVIGATE' && action.payload.path != null ? action.payload.path : route.path;
                return params !== route.params || path !== route.path ? _objectSpread(_objectSpread({}, route), {}, {
                  path: path,
                  params: params
                }) : route;
              })
            }), index, backBehavior, initialRouteName);
          }

        case 'GO_BACK':
          {
            if (state.history.length === 1) {
              return null;
            }

            var previousKey = state.history[state.history.length - 2].key;

            var _index = state.routes.findIndex(function (route) {
              return route.key === previousKey;
            });

            if (_index === -1) {
              return null;
            }

            return _objectSpread(_objectSpread({}, state), {}, {
              history: state.history.slice(0, -1),
              index: _index
            });
          }

        default:
          return _BaseRouter.default.getStateForAction(state, action);
      }
    },
    shouldActionChangeFocus: function shouldActionChangeFocus(action) {
      return action.type === 'NAVIGATE';
    },
    actionCreators: TabActions
  });

  return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRhYlJvdXRlci50c3giXSwibmFtZXMiOlsiVFlQRV9ST1VURSIsIlRhYkFjdGlvbnMiLCJqdW1wVG8iLCJ0eXBlIiwicGF5bG9hZCIsIm5hbWUiLCJwYXJhbXMiLCJnZXRSb3V0ZUhpc3RvcnkiLCJoaXN0b3J5Iiwia2V5Iiwicm91dGVzIiwiaSIsImluZGV4IiwiaW5pdGlhbFJvdXRlSW5kZXgiLCJyb3V0ZSIsImNoYW5nZUluZGV4IiwiYmFja0JlaGF2aW9yIiwiY3VycmVudEtleSIsInN0YXRlIiwiaXQiLCJyb3V0ZXIiLCJCYXNlUm91dGVyIiwiZ2V0SW5pdGlhbFN0YXRlIiwicm91dGVQYXJhbUxpc3QiLCJpbml0aWFsUm91dGVOYW1lIiwicm91dGVOYW1lcyIsInN0YWxlIiwiZ2V0UmVoeWRyYXRlZFN0YXRlIiwiciIsInVuZGVmaW5lZCIsIk1hdGgiLCJnZXRTdGF0ZUZvclJvdXRlTmFtZXNDaGFuZ2UiLCJyb3V0ZUtleUNoYW5nZXMiLCJnZXRTdGF0ZUZvclJvdXRlRm9jdXMiLCJnZXRTdGF0ZUZvckFjdGlvbiIsImFjdGlvbiIsInBhdGgiLCJwcmV2aW91c0tleSIsInNob3VsZEFjdGlvbkNoYW5nZUZvY3VzIiwiYWN0aW9uQ3JlYXRvcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxJQUFBLFVBQUEsR0FBQSxPQUFBLENBQUEsbUJBQUEsQ0FBQTs7QUFFQSxJQUFBLFdBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsZ0JBQUEsQ0FBQTs7Ozs7Ozs7QUF5REEsSUFBTUEsVUFBVSxHQUFoQixPQUFBO0FBRU8sSUFBTUMsVUFBVSxHQUFHO0FBQ3hCQyxFQUFBQSxNQUR3QixrQkFDbEIsSUFEa0IsRUFDbEIsTUFEa0IsRUFDNkI7QUFDbkQsV0FBTztBQUFFQyxNQUFBQSxJQUFJLEVBQU4sU0FBQTtBQUFtQkMsTUFBQUEsT0FBTyxFQUFFO0FBQUVDLFFBQUFBLElBQUYsRUFBRUEsSUFBRjtBQUFRQyxRQUFBQSxNQUFBQSxFQUFBQTtB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Z0JBQU1OLE1BQUssR0FBR00sS0FBSyxDQUFMQSxNQUFBQSxDQUFBQSxTQUFBQSxDQUNYSixVQUFBQSxLQUFEO0FBQUEscUJBQVdBLEtBQUssQ0FBTEEsR0FBQUEsS0FEYixXQUNFO0FBQUEsYUFEWUksQ0FBZDs7QUFJQSxnQkFBSU4sTUFBSyxLQUFLLENBQWQsQ0FBQSxFQUFrQjtBQUNoQixxQkFBQSxJQUFBO0FBQ0Q7O0FBRUQsbURBQU8sS0FBUDtBQUVFSixjQUFBQSxPQUFPLEVBQUVVLEtBQUssQ0FBTEEsT0FBQUEsQ0FBQUEsS0FBQUEsQ0FBQUEsQ0FBQUEsRUFBdUIsQ0FGM0IsQ0FFSUEsQ0FGWDtBQUdFTixjQUFBQSxLQUFBQSxFQUFBQTtBQUhGO0FBS0Q7O0FBRUQ7QUFDRSxpQkFBT1MsV0FBQUEsQ0FBQUEsT0FBQUEsQ0FBQUEsaUJBQUFBLENBQUFBLEtBQUFBLEVBQVAsTUFBT0EsQ0FBUDtBQXZGSjtBQWpKQSxLQUFIO0FBNE9DaUIsSUFBQUEsdUJBNU9ELG1DQTRPd0IsTUE1T3hCLEVBNE9pQztBQUM5QixhQUFPSCxNQUFNLENBQU5BLElBQUFBLEtBQVAsVUFBQTtBQTdPQSxLQUFIO0FBZ1BDSSxJQUFBQSxjQUFjLEVBQUV0QztBQWhQakIsSUFIRDs7QUFzUEEsU0FBQSxNQUFBO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBuYW5vaWQgfSBmcm9tICduYW5vaWQvbm9uLXNlY3VyZSc7XG5cbmltcG9ydCBCYXNlUm91dGVyIGZyb20gJy4vQmFzZVJvdXRlcic7XG5pbXBvcnQgdHlwZSB7XG4gIENvbW1vbk5hdmlnYXRpb25BY3Rpb24sXG4gIERlZmF1bHRSb3V0ZXJPcHRpb25zLFxuICBOYXZpZ2F0aW9uU3RhdGUsXG4gIFBhcmFtTGlzdEJhc2UsXG4gIFBhcnRpYWxTdGF0ZSxcbiAgUm91dGUsXG4gIFJvdXRlcixcbn0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCB0eXBlIFRhYkFjdGlvblR5cGUgPSB7XG4gIHR5cGU6ICdKVU1QX1RPJztcbiAgcGF5bG9hZDogeyBuYW1lOiBzdHJpbmc7IHBhcmFtcz86IG9iamVjdCB9O1xuICBzb3VyY2U/OiBzdHJpbmc7XG4gIHRhcmdldD86IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIEJhY2tCZWhhdmlvciA9XG4gIHwgJ2luaXRpYWxSb3V0ZSdcbiAgfCAnZmlyc3RSb3V0ZSdcbiAgfCAnaGlzdG9yeSdcbiAgfCAnb3JkZXInXG4gIHwgJ25vbmUnO1xuXG5leHBvcnQgdHlwZSBUYWJSb3V0ZXJPcHRpb25zID0gRGVmYXVsdFJvdXRlck9wdGlvbnMgJiB7XG4gIGJhY2tCZWhhdmlvcj86IEJhY2tCZWhhdmlvcjtcbn07XG5cbmV4cG9ydCB0eXBlIFRhYk5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3QgZXh0ZW5kcyBQYXJhbUxpc3RCYXNlPiA9IE9taXQ8XG4gIE5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3Q+LFxuICAnaGlzdG9yeSdcbj4gJiB7XG4gIC8qKlxuICAgKiBUeXBlIG9mIHRoZSByb3V0ZXIsIGluIHRoaXMgY2FzZSwgaXQncyB0YWIuXG4gICAqL1xuICB0eXBlOiAndGFiJztcbiAgLyoqXG4gICAqIExpc3Qgb2YgcHJldmlvdXNseSB2aXNpdGVkIHJvdXRlIGtleXMuXG4gICAqL1xuICBoaXN0b3J5OiB7IHR5cGU6ICdyb3V0ZSc7IGtleTogc3RyaW5nIH1bXTtcbn07XG5cbmV4cG9ydCB0eXBlIFRhYkFjdGlvbkhlbHBlcnM8UGFyYW1MaXN0IGV4dGVuZHMgUGFyYW1MaXN0QmFzZT4gPSB7XG4gIC8qKlxuICAgKiBKdW1wIHRvIGFuIGV4aXN0aW5nIHRhYi5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgTmFtZSBvZiB0aGUgcm91dGUgZm9yIHRoZSB0YWIuXG4gICAqIEBwYXJhbSBbcGFyYW1zXSBQYXJhbXMgb2JqZWN0IGZvciB0aGUgcm91dGUuXG4gICAqL1xuICBqdW1wVG88Um91dGVOYW1lIGV4dGVuZHMgRXh0cmFjdDxrZXlvZiBQYXJhbUxpc3QsIHN0cmluZz4+KFxuICAgIC4uLmFyZ3M6IHVuZGVmaW5lZCBleHRlbmRzIFBhcmFtTGlzdFtSb3V0ZU5hbWVdXG4gICAgICA/IFtzY3JlZW46IFJvdXRlTmFtZV0gfCBbc2NyZWVuOiBSb3V0ZU5hbWUsIHBhcmFtczogUGFyYW1MaXN0W1JvdXRlTmFtZV1dXG4gICAgICA6IFtzY3JlZW46IFJvdXRlTmFtZSwgcGFyYW1zOiBQYXJhbUxpc3RbUm91dGVOYW1lXV1cbiAgKTogdm9pZDtcbn07XG5cbmNvbnN0IFRZUEVfUk9VVEUgPSAncm91dGUnIGFzIGNvbnN0O1xuXG5leHBvcnQgY29uc3QgVGFiQWN0aW9ucyA9IHtcbiAganVtcFRvKG5hbWU6IHN0cmluZywgcGFyYW1zPzogb2JqZWN0KTogVGFiQWN0aW9uVHlwZSB7XG4gICAgcmV0dXJuIHsgdHlwZTogJ0pVTVBfVE8nLCBwYXlsb2FkOiB7IG5hbWUsIHBhcmFtcyB9IH07XG4gIH0sXG59O1xuXG5jb25zdCBnZXRSb3V0ZUhpc3RvcnkgPSAoXG4gIHJvdXRlczogUm91dGU8c3RyaW5nPltdLFxuICBpbmRleDogbnVtYmVyLFxuICBiYWNrQmVoYXZpb3I6IEJhY2tCZWhhdmlvcixcbiAgaW5pdGlhbFJvdXRlTmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkXG4pID0+IHtcbiAgY29uc3QgaGlzdG9yeSA9IFt7IHR5cGU6IFRZUEVfUk9VVEUsIGtleTogcm91dGVzW2luZGV4XS5rZXkgfV07XG4gIGxldCBpbml0aWFsUm91dGVJbmRleDtcblxuICBzd2l0Y2ggKGJhY2tCZWhhdmlvcikge1xuICAgIGNhc2UgJ29yZGVyJzpcbiAgICAgIGZvciAobGV0IGkgPSBpbmRleDsgaSA+IDA7IGktLSkge1xuICAgICAgICBoaXN0b3J5LnVuc2hpZnQoeyB0eXBlOiBUWVBFX1JPVVRFLCBrZXk6IHJvdXRlc1tpIC0gMV0ua2V5IH0pO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnZmlyc3RSb3V0ZSc6XG4gICAgICBpZiAoaW5kZXggIT09IDApIHtcbiAgICAgICAgaGlzdG9yeS51bnNoaWZ0KHtcbiAgICAgICAgICB0eXBlOiBUWVBFX1JPVVRFLFxuICAgICAgICAgIGtleTogcm91dGVzWzBdLmtleSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdpbml0aWFsUm91dGUnOlxuICAgICAgaW5pdGlhbFJvdXRlSW5kZXggPSByb3V0ZXMuZmluZEluZGV4KFxuICAgICAgICAocm91dGUpID0+IHJvdXRlLm5hbWUgPT09IGluaXRpYWxSb3V0ZU5hbWVcbiAgICAgICk7XG4gICAgICBpbml0aWFsUm91dGVJbmRleCA9IGluaXRpYWxSb3V0ZUluZGV4ID09PSAtMSA/IDAgOiBpbml0aWFsUm91dGVJbmRleDtcblxuICAgICAgaWYgKGluZGV4ICE9PSBpbml0aWFsUm91dGVJbmRleCkge1xuICAgICAgICBoaXN0b3J5LnVuc2hpZnQoe1xuICAgICAgICAgIHR5cGU6IFRZUEVfUk9VVEUsXG4gICAgICAgICAga2V5OiByb3V0ZXNbaW5pdGlhbFJvdXRlSW5kZXhdLmtleSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdoaXN0b3J5JzpcbiAgICAgIC8vIFRoZSBoaXN0b3J5IHdpbGwgZmlsbCB1cCBvbiBuYXZpZ2F0aW9uXG4gICAgICBicmVhaztcbiAgfVxuXG4gIHJldHVybiBoaXN0b3J5O1xufTtcblxuY29uc3QgY2hhbmdlSW5kZXggPSAoXG4gIHN0YXRlOiBUYWJOYXZpZ2F0aW9uU3RhdGU8UGFyYW1MaXN0QmFzZT4sXG4gIGluZGV4OiBudW1iZXIsXG4gIGJhY2tCZWhhdmlvcjogQmFja0JlaGF2aW9yLFxuICBpbml0aWFsUm91dGVOYW1lOiBzdHJpbmcgfCB1bmRlZmluZWRcbikgPT4ge1xuICBsZXQgaGlzdG9yeTtcblxuICBpZiAoYmFja0JlaGF2aW9yID09PSAnaGlzdG9yeScpIHtcbiAgICBjb25zdCBjdXJyZW50S2V5ID0gc3RhdGUucm91dGVzW2luZGV4XS5rZXk7XG5cbiAgICBoaXN0b3J5ID0gc3RhdGUuaGlzdG9yeVxuICAgICAgLmZpbHRlcigoaXQpID0+IChpdC50eXBlID09PSAncm91dGUnID8gaXQua2V5ICE9PSBjdXJyZW50S2V5IDogZmFsc2UpKVxuICAgICAgLmNvbmNhdCh7IHR5cGU6IFRZUEVfUk9VVEUsIGtleTogY3VycmVudEtleSB9KTtcbiAgfSBlbHNlIHtcbiAgICBoaXN0b3J5ID0gZ2V0Um91dGVIaXN0b3J5KFxuICAgICAgc3RhdGUucm91dGVzLFxuICAgICAgaW5kZXgsXG4gICAgICBiYWNrQmVoYXZpb3IsXG4gICAgICBpbml0aWFsUm91dGVOYW1lXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgLi4uc3RhdGUsXG4gICAgaW5kZXgsXG4gICAgaGlzdG9yeSxcbiAgfTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIFRhYlJvdXRlcih7XG4gIGluaXRpYWxSb3V0ZU5hbWUsXG4gIGJhY2tCZWhhdmlvciA9ICdmaXJzdFJvdXRlJyxcbn06IFRhYlJvdXRlck9wdGlvbnMpIHtcbiAgY29uc3Qgcm91dGVyOiBSb3V0ZXI8XG4gICAgVGFiTmF2aWdhdGlvblN0YXRlPFBhcmFtTGlzdEJhc2U+LFxuICAgIFRhYkFjdGlvblR5cGUgfCBDb21tb25OYXZpZ2F0aW9uQWN0aW9uXG4gID4gPSB7XG4gICAgLi4uQmFzZVJvdXRlcixcblxuICAgIHR5cGU6ICd0YWInLFxuXG4gICAgZ2V0SW5pdGlhbFN0YXRlKHsgcm91dGVOYW1lcywgcm91dGVQYXJhbUxpc3QgfSkge1xuICAgICAgY29uc3QgaW5kZXggPVxuICAgICAgICBpbml0aWFsUm91dGVOYW1lICE9PSB1bmRlZmluZWQgJiYgcm91dGVOYW1lcy5pbmNsdWRlcyhpbml0aWFsUm91dGVOYW1lKVxuICAgICAgICAgID8gcm91dGVOYW1lcy5pbmRleE9mKGluaXRpYWxSb3V0ZU5hbWUpXG4gICAgICAgICAgOiAwO1xuXG4gICAgICBjb25zdCByb3V0ZXMgPSByb3V0ZU5hbWVzLm1hcCgobmFtZSkgPT4gKHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAga2V5OiBgJHtuYW1lfS0ke25hbm9pZCgpfWAsXG4gICAgICAgIHBhcmFtczogcm91dGVQYXJhbUxpc3RbbmFtZV0sXG4gICAgICB9KSk7XG5cbiAgICAgIGNvbnN0IGhpc3RvcnkgPSBnZXRSb3V0ZUhpc3RvcnkoXG4gICAgICAgIHJvdXRlcyxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIGJhY2tCZWhhdmlvcixcbiAgICAgICAgaW5pdGlhbFJvdXRlTmFtZVxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhbGU6IGZhbHNlLFxuICAgICAgICB0eXBlOiAndGFiJyxcbiAgICAgICAga2V5OiBgdGFiLSR7bmFub2lkKCl9YCxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIHJvdXRlTmFtZXMsXG4gICAgICAgIGhpc3RvcnksXG4gICAgICAgIHJvdXRlcyxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIGdldFJlaHlkcmF0ZWRTdGF0ZShwYXJ0aWFsU3RhdGUsIHsgcm91dGVOYW1lcywgcm91dGVQYXJhbUxpc3QgfSkge1xuICAgICAgbGV0IHN0YXRlID0gcGFydGlhbFN0YXRlO1xuXG4gICAgICBpZiAoc3RhdGUuc3RhbGUgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgcm91dGVzID0gcm91dGVOYW1lcy5tYXAoKG5hbWUpID0+IHtcbiAgICAgICAgY29uc3Qgcm91dGUgPSAoXG4gICAgICAgICAgc3RhdGUgYXMgUGFydGlhbFN0YXRlPFRhYk5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3RCYXNlPj5cbiAgICAgICAgKS5yb3V0ZXMuZmluZCgocikgPT4gci5uYW1lID09PSBuYW1lKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLnJvdXRlLFxuICAgICAgICAgIG5hbWUsXG4gICAgICAgICAga2V5OlxuICAgICAgICAgICAgcm91dGUgJiYgcm91dGUubmFtZSA9PT0gbmFtZSAmJiByb3V0ZS5rZXlcbiAgICAgICAgICAgICAgPyByb3V0ZS5rZXlcbiAgICAgICAgICAgICAgOiBgJHtuYW1lfS0ke25hbm9pZCgpfWAsXG4gICAgICAgICAgcGFyYW1zOlxuICAgICAgICAgICAgcm91dGVQYXJhbUxpc3RbbmFtZV0gIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIC4uLnJvdXRlUGFyYW1MaXN0W25hbWVdLFxuICAgICAgICAgICAgICAgICAgLi4uKHJvdXRlID8gcm91dGUucGFyYW1zIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogcm91dGVcbiAgICAgICAgICAgICAgPyByb3V0ZS5wYXJhbXNcbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIH0gYXMgUm91dGU8c3RyaW5nPjtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBpbmRleCA9IE1hdGgubWluKFxuICAgICAgICBNYXRoLm1heChyb3V0ZU5hbWVzLmluZGV4T2Yoc3RhdGUucm91dGVzW3N0YXRlPy5pbmRleCA/PyAwXT8ubmFtZSksIDApLFxuICAgICAgICByb3V0ZXMubGVuZ3RoIC0gMVxuICAgICAgKTtcblxuICAgICAgY29uc3QgaGlzdG9yeSA9XG4gICAgICAgIHN0YXRlLmhpc3Rvcnk/LmZpbHRlcigoaXQpID0+IHJvdXRlcy5maW5kKChyKSA9PiByLmtleSA9PT0gaXQua2V5KSkgPz9cbiAgICAgICAgW107XG5cbiAgICAgIHJldHVybiBjaGFuZ2VJbmRleChcbiAgICAgICAge1xuICAgICAgICAgIHN0YWxlOiBmYWxzZSxcbiAgICAgICAgICB0eXBlOiAndGFiJyxcbiAgICAgICAgICBrZXk6IGB0YWItJHtuYW5vaWQoKX1gLFxuICAgICAgICAgIGluZGV4LFxuICAgICAgICAgIHJvdXRlTmFtZXMsXG4gICAgICAgICAgaGlzdG9yeSxcbiAgICAgICAgICByb3V0ZXMsXG4gICAgICAgIH0sXG4gICAgICAgIGluZGV4LFxuICAgICAgICBiYWNrQmVoYXZpb3IsXG4gICAgICAgIGluaXRpYWxSb3V0ZU5hbWVcbiAgICAgICk7XG4gICAgfSxcblxuICAgIGdldFN0YXRlRm9yUm91dGVOYW1lc0NoYW5nZShcbiAgICAgIHN0YXRlLFxuICAgICAgeyByb3V0ZU5hbWVzLCByb3V0ZVBhcmFtTGlzdCwgcm91dGVLZXlDaGFuZ2VzIH1cbiAgICApIHtcbiAgICAgIGNvbnN0IHJvdXRlcyA9IHJvdXRlTmFtZXMubWFwKFxuICAgICAgICAobmFtZSkgPT5cbiAgICAgICAgICBzdGF0ZS5yb3V0ZXMuZmluZChcbiAgICAgICAgICAgIChyKSA9PiByLm5hbWUgPT09IG5hbWUgJiYgIXJvdXRlS2V5Q2hhbmdlcy5pbmNsdWRlcyhyLm5hbWUpXG4gICAgICAgICAgKSB8fCB7XG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAga2V5OiBgJHtuYW1lfS0ke25hbm9pZCgpfWAsXG4gICAgICAgICAgICBwYXJhbXM6IHJvdXRlUGFyYW1MaXN0W25hbWVdLFxuICAgICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGluZGV4ID0gTWF0aC5tYXgoXG4gICAgICAgIDAsXG4gICAgICAgIHJvdXRlTmFtZXMuaW5kZXhPZihzdGF0ZS5yb3V0ZXNbc3RhdGUuaW5kZXhdLm5hbWUpXG4gICAgICApO1xuXG4gICAgICBsZXQgaGlzdG9yeSA9IHN0YXRlLmhpc3RvcnkuZmlsdGVyKFxuICAgICAgICAvLyBUeXBlIHdpbGwgYWx3YXlzIGJlICdyb3V0ZScgZm9yIHRhYnMsIGJ1dCBjb3VsZCBiZSBkaWZmZXJlbnQgaW4gYSByb3V0ZXIgZXh0ZW5kaW5nIHRoaXMgKGUuZy4gZHJhd2VyKVxuICAgICAgICAoaXQpID0+IGl0LnR5cGUgIT09ICdyb3V0ZScgfHwgcm91dGVzLmZpbmQoKHIpID0+IHIua2V5ID09PSBpdC5rZXkpXG4gICAgICApO1xuXG4gICAgICBpZiAoIWhpc3RvcnkubGVuZ3RoKSB7XG4gICAgICAgIGhpc3RvcnkgPSBnZXRSb3V0ZUhpc3RvcnkoXG4gICAgICAgICAgcm91dGVzLFxuICAgICAgICAgIGluZGV4LFxuICAgICAgICAgIGJhY2tCZWhhdmlvcixcbiAgICAgICAgICBpbml0aWFsUm91dGVOYW1lXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBoaXN0b3J5LFxuICAgICAgICByb3V0ZU5hbWVzLFxuICAgICAgICByb3V0ZXMsXG4gICAgICAgIGluZGV4LFxuICAgICAgfTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdGVGb3JSb3V0ZUZvY3VzKHN0YXRlLCBrZXkpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gc3RhdGUucm91dGVzLmZpbmRJbmRleCgocikgPT4gci5rZXkgPT09IGtleSk7XG5cbiAgICAgIGlmIChpbmRleCA9PT0gLTEgfHwgaW5kZXggPT09IHN0YXRlLmluZGV4KSB7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNoYW5nZUluZGV4KHN0YXRlLCBpbmRleCwgYmFja0JlaGF2aW9yLCBpbml0aWFsUm91dGVOYW1lKTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdGVGb3JBY3Rpb24oc3RhdGUsIGFjdGlvbiwgeyByb3V0ZVBhcmFtTGlzdCB9KSB7XG4gICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgIGNhc2UgJ0pVTVBfVE8nOlxuICAgICAgICBjYXNlICdOQVZJR0FURSc6IHtcbiAgICAgICAgICBsZXQgaW5kZXggPSAtMTtcblxuICAgICAgICAgIGlmIChhY3Rpb24udHlwZSA9PT0gJ05BVklHQVRFJyAmJiBhY3Rpb24ucGF5bG9hZC5rZXkpIHtcbiAgICAgICAgICAgIGluZGV4ID0gc3RhdGUucm91dGVzLmZpbmRJbmRleChcbiAgICAgICAgICAgICAgKHJvdXRlKSA9PiByb3V0ZS5rZXkgPT09IGFjdGlvbi5wYXlsb2FkLmtleVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaW5kZXggPSBzdGF0ZS5yb3V0ZXMuZmluZEluZGV4KFxuICAgICAgICAgICAgICAocm91dGUpID0+IHJvdXRlLm5hbWUgPT09IGFjdGlvbi5wYXlsb2FkLm5hbWVcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIGNoYW5nZUluZGV4KFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgICAgcm91dGVzOiBzdGF0ZS5yb3V0ZXMubWFwKChyb3V0ZSwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChpICE9PSBpbmRleCkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJvdXRlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBwYXJhbXM7XG5cbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT09ICdOQVZJR0FURScgJiYgYWN0aW9uLnBheWxvYWQubWVyZ2UpIHtcbiAgICAgICAgICAgICAgICAgIHBhcmFtcyA9XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkLnBhcmFtcyAhPT0gdW5kZWZpbmVkIHx8XG4gICAgICAgICAgICAgICAgICAgIHJvdXRlUGFyYW1MaXN0W3JvdXRlLm5hbWVdICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ucm91dGVQYXJhbUxpc3Rbcm91dGUubmFtZV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnJvdXRlLnBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uYWN0aW9uLnBheWxvYWQucGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIDogcm91dGUucGFyYW1zO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBwYXJhbXMgPVxuICAgICAgICAgICAgICAgICAgICByb3V0ZVBhcmFtTGlzdFtyb3V0ZS5uYW1lXSAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnJvdXRlUGFyYW1MaXN0W3JvdXRlLm5hbWVdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5hY3Rpb24ucGF5bG9hZC5wYXJhbXMsXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgOiBhY3Rpb24ucGF5bG9hZC5wYXJhbXM7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9XG4gICAgICAgICAgICAgICAgICBhY3Rpb24udHlwZSA9PT0gJ05BVklHQVRFJyAmJiBhY3Rpb24ucGF5bG9hZC5wYXRoICE9IG51bGxcbiAgICAgICAgICAgICAgICAgICAgPyBhY3Rpb24ucGF5bG9hZC5wYXRoXG4gICAgICAgICAgICAgICAgICAgIDogcm91dGUucGF0aDtcblxuICAgICAgICAgICAgICAgIHJldHVybiBwYXJhbXMgIT09IHJvdXRlLnBhcmFtcyB8fCBwYXRoICE9PSByb3V0ZS5wYXRoXG4gICAgICAgICAgICAgICAgICA/IHsgLi4ucm91dGUsIHBhdGgsIHBhcmFtcyB9XG4gICAgICAgICAgICAgICAgICA6IHJvdXRlO1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgIGJhY2tCZWhhdmlvcixcbiAgICAgICAgICAgIGluaXRpYWxSb3V0ZU5hbWVcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY2FzZSAnR09fQkFDSyc6IHtcbiAgICAgICAgICBpZiAoc3RhdGUuaGlzdG9yeS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IHByZXZpb3VzS2V5ID0gc3RhdGUuaGlzdG9yeVtzdGF0ZS5oaXN0b3J5Lmxlbmd0aCAtIDJdLmtleTtcbiAgICAgICAgICBjb25zdCBpbmRleCA9IHN0YXRlLnJvdXRlcy5maW5kSW5kZXgoXG4gICAgICAgICAgICAocm91dGUpID0+IHJvdXRlLmtleSA9PT0gcHJldmlvdXNLZXlcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLnN0YXRlLFxuICAgICAgICAgICAgaGlzdG9yeTogc3RhdGUuaGlzdG9yeS5zbGljZSgwLCAtMSksXG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gQmFzZVJvdXRlci5nZXRTdGF0ZUZvckFjdGlvbihzdGF0ZSwgYWN0aW9uKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgc2hvdWxkQWN0aW9uQ2hhbmdlRm9jdXMoYWN0aW9uKSB7XG4gICAgICByZXR1cm4gYWN0aW9uLnR5cGUgPT09ICdOQVZJR0FURSc7XG4gICAgfSxcblxuICAgIGFjdGlvbkNyZWF0b3JzOiBUYWJBY3Rpb25zLFxuICB9O1xuXG4gIHJldHVybiByb3V0ZXI7XG59XG4iXX0=